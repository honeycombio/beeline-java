version: 2.1

commands:
  build:
    parameters:
      javaversion:
        type: string
        default: "8"
    steps:
      - checkout
      - restore_cache:
          key: beeline-java-{{ checksum "pom.xml" }}-<< parameters.javaversion >>
      - run: ./mvnw package dependency:go-offline
      - save_cache:
          paths:
            - ~/.m2
          key: beeline-java-{{ checksum "pom.xml" }}-<< parameters.javaversion >>
      - persist_to_workspace:
          root: .
          paths:
            - ./<< parameters.javaversion >>
      # - store_artifacts:
      #     path: artifacts
  publish:
    parameters:
      javaversion:
        type: string
        default: "8"
    steps:
      - restore_cache:
        key: beeline-java-{{ checksum "pom.xml" }}-<< parameters.javaversion >>
      - run: ./mvnw -B deploy

jobs:
  java:
    parameters:
      javaversion:
        type: string
        default: "8"
    docker:
      - image: circleci/openjdk:<< parameters.javaversion >>-jdk
    steps:
      - build
  publish:
    parameters:
      javaversion:
        type: string
        default: "8"
    executor:
      name: java
      javaversion: "<< parameters.javaversion >>"
    steps:
      - publish
  # publish_github:
  #   docker:
  #     - image: cibuilds/github:0.13.0
  #   steps:
  #     - attach_workspace:
  #         at: ~/
  #     - run:
  #         name: "Publish Release on GitHub"
  #         command: |
  #           echo "about to publish to tag ${CIRCLE_TAG}"
  #           ls -l ~/artifacts/*
  #           ghr -draft -n ${CIRCLE_TAG} -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} ${CIRCLE_TAG} ~/artifacts
  # publish_maven:
  #   docker:
  #     - image: circleci/openjdk:11-jdk
  #   steps:
  #     - attach_workspace:
  #         at: ~/
  #     - restore_cache:
  #         key: beeline-java-{{ checksum "pom.xml" }}-11
  #     - run: ./mvnw -B deploy -DskipTests

workflows:
  version: 2
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - java:
          javaversion: "8"
          name: JDK-8
      - java:
          javaversion: "9"
          name: JDK-9
      - java:
          javaversion: "10"
          name: JDK-10
      - java:
          javaversion: "11"
          name: JDK-11
  build:
    jobs:
      - java:
          javaversion: "8"
          name: JDK-8
      - java:
          javaversion: "9"
          name: JDK-9
      - java:
          javaversion: "10"
          name: JDK-10
      - java:
          javaversion: "11"
          name: JDK-11
      # - publish_github:
      #     context: Honeycomb Secrets
      #     requires:
      #       - java:
      #         javaversion: "11"
      #         name: JDK-11
      #     filters:
      #       tags:
      #         only: /^v.*/
      #       branches:
      #         ignore: /.*/
      # - publish_maven:
      #     requires:
      #       - build
      #     filters:
      #       tags:
      #         only: /^v.*/
      #       branches:
      #         ignore: /.*/
